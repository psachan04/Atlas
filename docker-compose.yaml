services:
  db:
    image: pgvector/pgvector:pg16
    container_name: nps_postgres
    environment:
      POSTGRES_USER: atlas_admin
      POSTGRES_PASSWORD: atlas123
      POSTGRES_DB: nps_db
    ports:
      - "8000:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init_pgvector.sql:/docker-entrypoint-initdb.d/init_pgvector.sql
    healthcheck: # â† ADD THESE LINES
      test: [ "CMD-SHELL", "pg_isready -U atlas_admin -d nps_db" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - nps_network

  airflow:
    # image: apache/airflow:2.10.0-python3.11
    build: .
    container_name: nps_airflow
    # This command initializes the DB, creates the user safely, and starts Airflow
    command: >
      bash -c "airflow db init &&
      (airflow users create --username admin --firstname Atlas --lastname Admin --role Admin --email admin@example.com --password admin || true) &&
      airflow standalone"
    environment:
      # - _PIP_ADDITIONAL_DEPENDENCIES=dbt-postgres
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://atlas_admin:atlas123@db:5432/nps_db
      - AIRFLOW__CORE__LOAD_EXAMPLES=False
      - PYTHONPATH=/opt/airflow
    volumes:
      - ${PWD}/dags:/opt/airflow/dags:z
      - ${PWD}/src:/opt/airflow/src:z
      - ${PWD}/transform:/opt/airflow/transform:z
      - ${PWD}/.env:/opt/airflow/.env:z
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - nps_network

  rangergpt:
      build:
        context: .
        dockerfile: Dockerfile.rangergpt
      container_name: nps_rangergpt
      environment:
        - GEMINI_API_KEY=${GEMINI_API_KEY}
        - DB_HOST=db
        - DB_PORT=5432
        - DB_NAME=nps_db
        - DB_USER=atlas_admin
        - DB_PASSWORD=atlas123
        - PYTHONPATH=/app
      volumes:
        - ${PWD}/src:/app/src:z
        - ${PWD}/scripts:/app/scripts:z
        - ${PWD}/transform:/app/transform:z
        - ${PWD}/.env:/app/.env:z
      depends_on:
        db:
          condition: service_healthy
      networks:
        - nps_network
      stdin_open: true
      tty: true
      # Keep container running for interactive use
      command: tail -f /dev/null

networks:
  nps_network:
    driver: bridge

volumes:
  postgres_data: